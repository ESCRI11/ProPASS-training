{
  "hash": "7bdad8a18465c088ec77406653e44375",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Derived Variables & Grouped Summaries\"\nformat: html\nengine: knitr\n---\n\n::: {.cell}\n<style type=\"text/css\">\np {\n  text-align: justify\n}\n</style>\n:::\n\n\n\n\nThis chapter covers creating derived variables and performing grouped summaries in DataSHIELD.\n\n## Overview\n\nDerived variables are new variables computed from existing ones. This chapter covers:\n\n- Arithmetic operations with `ds.make()`\n- Getting quantiles for model knots\n- Grouped summaries and tabulations\n- Combining variables into data frames\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load required packages\nlibrary(DSI)\nlibrary(DSOpal)\nlibrary(dsBaseClient)\nlibrary(dsTidyverseClient)\n\n# Connect to the server\nbuilder <- DSI::newDSLoginBuilder()\nbuilder$append(\n  server = \"demo\",\n  url = \"https://opal-demo.obiba.org\",\n  user = \"dsuser\",\n  password = \"P@ssw0rd\",\n  table = \"CNSIM.CNSIM1\",\n  profile = \"lemon-donkey\"\n)\nlogindata <- builder$build()\nconns <- datashield.login(logins = logindata, assign = TRUE, symbol = \"D\")\n```\n:::\n\n\n\n\n## Arithmetic Operations with ds.make()\n\nUse `ds.make()` to create new variables from arithmetic expressions:\n\n### Ratios and Calculations\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create HDL to total cholesterol ratio\nds.make(\n  toAssign = \"D$LAB_HDL / D$LAB_TSC\",\n  newobj = \"hdl_ratio\"\n)\nds.dataFrame(x = c(\"D\", \"hdl_ratio\"), newobj = \"D\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nds.summary(\"D$hdl_ratio\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$demo\n$demo$class\n[1] \"numeric\"\n\n$demo$length\n[1] 2163\n\n$demo$`quantiles & mean`\n       5%       10%       25%       50%       75%       90%       95%      Mean \n0.1313137 0.1655379 0.2145864 0.2730897 0.3371916 0.4000319 0.4549046 0.2799964 \n```\n\n\n:::\n:::\n\n\n\n\n### Log Transformations\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Log-transform triglycerides (common for skewed distributions)\nds.make(\n  toAssign = \"log(D$LAB_TRIG)\",\n  newobj = \"log_trig\"\n)\nds.dataFrame(x = c(\"D\", \"log_trig\"), newobj = \"D\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nds.summary(\"D$log_trig\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$demo\n$demo$class\n[1] \"numeric\"\n\n$demo$length\n[1] 2163\n\n$demo$`quantiles & mean`\n        5%        10%        25%        50%        75%        90%        95% \n-0.9797256 -0.4005223  0.2723146  0.8232979  1.1665824  1.4211788  1.5478593 \n      Mean \n 0.6161325 \n```\n\n\n:::\n:::\n\n\n\n\n### Variable Copies\n\nCreate copies of variables with new names (useful for analysis):\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create primary exposure variable\nds.make(\n  toAssign = \"D$PM_BMI_CONTINUOUS\",\n  newobj = \"Primary_exposure\"\n)\n\nds.dataFrame(x = c(\"D\", \"Primary_exposure\"), newobj = \"D\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nds.colnames(\"D\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$demo\n [1] \"LAB_TSC\"            \"LAB_TRIG\"           \"LAB_HDL\"           \n [4] \"LAB_GLUC_ADJUSTED\"  \"PM_BMI_CONTINUOUS\"  \"DIS_CVA\"           \n [7] \"MEDI_LPD\"           \"DIS_DIAB\"           \"DIS_AMI\"           \n[10] \"GENDER\"             \"PM_BMI_CATEGORICAL\" \"hdl_ratio\"         \n[13] \"log_trig\"           \"Primary_exposure\"  \n```\n\n\n:::\n:::\n\n\n\n\n### Creating Constant Vectors\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create knots for restricted cubic splines\n# Get quantiles first: ds.quantileMean(\"D$PM_BMI_CONTINUOUS\")\nds.make(\n  toAssign = \"c(23.5, 27.5, 32.8)\",\n  newobj = \"knots\"\n)\n```\n:::\n\n\n\n\n## Getting Quantiles\n\nUse `ds.quantileMean()` to get percentiles for setting cutpoints:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get quantiles for BMI (used for knots in spline models)\nds.quantileMean(x = \"D$PM_BMI_CONTINUOUS\", type = \"combine\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n Quantiles of the pooled data\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      5%      10%      25%      50%      75%      90%      95%     Mean \n19.49500 21.06500 24.10500 27.33000 30.66750 33.76000 35.66750 27.39804 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Get quantiles for cholesterol\nds.quantileMean(x = \"D$LAB_TSC\", type = \"combine\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n Quantiles of the pooled data\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      5%      10%      25%      50%      75%      90%      95%     Mean \n4.089300 4.492600 5.108500 5.856000 6.593500 7.311400 7.738500 5.872113 \n```\n\n\n:::\n:::\n\n\n\n\n## Checking for Missing Data\n\nBefore analysis, check for missing values:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Count missing values in variables\nds.numNA(x = \"D$LAB_TSC\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$demo\n[1] 356\n```\n\n\n:::\n\n```{.r .cell-code}\nds.numNA(x = \"D$LAB_HDL\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$demo\n[1] 360\n```\n\n\n:::\n\n```{.r .cell-code}\nds.numNA(x = \"D$PM_BMI_CONTINUOUS\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$demo\n[1] 97\n```\n\n\n:::\n:::\n\n\n\n\n## Statistical Summaries\n\n### Variable Summary\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Full summary of a variable\nds.summary(\"D$PM_BMI_CONTINUOUS\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$demo\n$demo$class\n[1] \"numeric\"\n\n$demo$length\n[1] 2163\n\n$demo$`quantiles & mean`\n      5%      10%      25%      50%      75%      90%      95%     Mean \n19.49500 21.06500 24.10500 27.33000 30.66750 33.76000 35.66750 27.39804 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Mean\nds.mean(\"D$PM_BMI_CONTINUOUS\", type = \"combine\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$Global.Mean\n                EstimatedMean Nmissing Nvalid Ntotal\nstudiesCombined      27.39804       97   2066   2163\n\n$Nstudies\n[1] 1\n\n$ValidityMessage\n     ValidityMessage \ndemo \"VALID ANALYSIS\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# Variance\nds.var(\"D$PM_BMI_CONTINUOUS\", type = \"combine\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$Global.Variance\n                EstimatedVar Nmissing Nvalid Ntotal\nstudiesCombined     25.21478       97   2066   2163\n\n$Nstudies\n[1] 1\n\n$ValidityMessage\n     ValidityMessage \ndemo \"VALID ANALYSIS\"\n```\n\n\n:::\n:::\n\n\n\n\n### Grouped Summaries with ds.tapply()\n\nCalculate statistics by group:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Mean BMI by gender\nds.tapply(\n  X.name = \"D$PM_BMI_CONTINUOUS\",\n  INDEX.names = \"D$GENDER\",\n  FUN.name = \"mean\"\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$demo\n$demo$Mean\nD$GENDER.1 D$GENDER.2 \n  28.10222   26.69113 \n\n$demo$N\nD$GENDER.1 D$GENDER.2 \n      1035       1031 \n```\n\n\n:::\n\n```{.r .cell-code}\n# SD of BMI by gender\nds.tapply(\n  X.name = \"D$PM_BMI_CONTINUOUS\",\n  INDEX.names = \"D$GENDER\",\n  FUN.name = \"sd\"\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$demo\n$demo$SD\nD$GENDER.1 D$GENDER.2 \n  5.102012   4.839615 \n\n$demo$N\nD$GENDER.1 D$GENDER.2 \n      1035       1031 \n```\n\n\n:::\n:::\n\n\n\n\n### Cross-Tabulations\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Single variable frequency\nds.table(\"D$GENDER\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Data in all studies were valid \n\nStudy 1 :  No errors reported from this study\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$output.list\n$output.list$TABLE_rvar.by.study_row.props\n        study\nD$GENDER demo\n      0     1\n      1     1\n      NA  NaN\n\n$output.list$TABLE_rvar.by.study_col.props\n        study\nD$GENDER      demo\n      0  0.5048544\n      1  0.4951456\n      NA 0.0000000\n\n$output.list$TABLE_rvar.by.study_counts\n        study\nD$GENDER demo\n      0  1092\n      1  1071\n      NA    0\n\n$output.list$TABLES.COMBINED_all.sources_proportions\nD$GENDER\n    0     1    NA \n0.505 0.495 0.000 \n\n$output.list$TABLES.COMBINED_all.sources_counts\nD$GENDER\n   0    1   NA \n1092 1071    0 \n\n\n$validity.message\n[1] \"Data in all studies were valid\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# Two-way table: gender by diabetes\nds.table(\n  rvar = \"D$GENDER\",\n  cvar = \"D$DIS_DIAB\"\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Data in all studies were valid \n\nStudy 1 :  No errors reported from this study\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$output.list\n$output.list$TABLE.STUDY.demo_row.props\n        D$DIS_DIAB\nD$GENDER     0      1  NA\n      0  0.981 0.0192   0\n      1  0.992 0.0084   0\n      NA   NaN    NaN NaN\n\n$output.list$TABLE.STUDY.demo_col.props\n        D$DIS_DIAB\nD$GENDER     0   1  NA\n      0  0.502 0.7 NaN\n      1  0.498 0.3 NaN\n      NA 0.000 0.0 NaN\n\n$output.list$TABLES.COMBINED_all.sources_row.props\n        D$DIS_DIAB\nD$GENDER     0      1  NA\n      0  0.981 0.0192   0\n      1  0.992 0.0084   0\n      NA   NaN    NaN NaN\n\n$output.list$TABLES.COMBINED_all.sources_col.props\n        D$DIS_DIAB\nD$GENDER     0   1  NA\n      0  0.502 0.7 NaN\n      1  0.498 0.3 NaN\n      NA 0.000 0.0 NaN\n\n$output.list$TABLE_STUDY.demo_counts\n        D$DIS_DIAB\nD$GENDER    0  1 NA\n      0  1071 21  0\n      1  1062  9  0\n      NA    0  0  0\n\n$output.list$TABLES.COMBINED_all.sources_counts\n        D$DIS_DIAB\nD$GENDER    0  1 NA\n      0  1071 21  0\n      1  1062  9  0\n      NA    0  0  0\n\n\n$validity.message\n[1] \"Data in all studies were valid\"\n```\n\n\n:::\n:::\n\n\n\n\n## Combining Variables into Data Frames\n\n### Creating New Data Frames\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Combine variables into a new data frame\nds.dataFrame(\n  x = c(\"D$PM_BMI_CONTINUOUS\", \"D$LAB_TSC\", \"D$LAB_HDL\", \"D$LAB_TRIG\", \"D$GENDER\", \"D$DIS_DIAB\"),\n  newobj = \"D_analysis\"\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nds.colnames(\"D_analysis\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$demo\n[1] \"PM_BMI_CONTINUOUS\" \"LAB_TSC\"           \"LAB_HDL\"          \n[4] \"LAB_TRIG\"          \"GENDER\"            \"DIS_DIAB\"         \n```\n\n\n:::\n\n```{.r .cell-code}\nds.dim(\"D_analysis\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$`dimensions of D_analysis in demo`\n[1] 2163    6\n\n$`dimensions of D_analysis in combined studies`\n[1] 2163    6\n```\n\n\n:::\n:::\n\n\n\n\n### Adding Variables to Existing Data Frames\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Add derived variables\nds.dataFrame(\n  x = c(\"D\", \"hdl_ratio\", \"log_trig\"),\n  newobj = \"D\"\n)\n\n# Or use ds.cbind\nds.cbind(\n  x = c(\"D_analysis\", \"hdl_ratio\"),\n  newobj = \"D_extended\"\n)\n\nds.colnames(\"D_extended\")\n```\n:::\n\n\n\n\n## Correlation Analysis\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Correlation between BMI and cholesterol\nds.cor(\n  x = \"D$PM_BMI_CONTINUOUS\",\n  y = \"D$LAB_TSC\"\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$demo\n$demo$`Number of missing values in each variable`\n     x.val y.val\n[1,]    97   356\n\n$demo$`Number of missing values casewise`\n      x.val y.val\nx.val   427   427\ny.val   427   427\n\n$demo$`Correlation Matrix`\n           [,1]       [,2]\n[1,] 1.00000000 0.01256042\n[2,] 0.01256042 1.00000000\n\n$demo$`Number of complete cases used`\n      x.val y.val\nx.val  1736  1736\ny.val  1736  1736\n```\n\n\n:::\n:::\n\n\n\n\n## Best Practices\n\n::: {.callout-tip}\n## Derived Variables Tips\n1. **Check for missing data** with `ds.numNA()` before creating derived variables\n2. **Add variables to data frames** immediately after creation with `ds.dataFrame()`\n3. **Use meaningful names** like `Primary_exposure` for clarity in models\n4. **Get quantiles** for setting appropriate knots in spline models\n5. **Verify your work** with `ds.summary()` and `ds.dim()`\n:::\n\n\n\n\n\n\n\n\n\n## Next Steps\n\nContinue to [Table One](6-table-one.qmd) to learn about creating descriptive statistics tables.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}