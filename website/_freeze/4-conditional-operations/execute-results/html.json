{
  "hash": "994d597e9be7b1ee14f0f35734edf0c0",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Conditional Operations\"\nformat: html\nengine: knitr\n---\n\n::: {.cell}\n<style type=\"text/css\">\np {\n  text-align: justify\n}\n</style>\n:::\n\n\n\n\nThis chapter covers applying conditional operations to create new variables in DataSHIELD.\n\n## Overview\n\nConditional operations allow you to create new variables based on conditions applied to existing variables. We use the tidyverse-style functions from `dsTidyverseClient`:\n\n- `ds.case_when()` - Multiple conditions (like SQL CASE WHEN)\n- `ds.if_else()` - Simple binary if-else logic\n- `ds.recodeValues()` - Recode specific values\n- `ds.asNumeric()` / `ds.asFactor()` - Convert variable types\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load required packages\nlibrary(DSI)\nlibrary(DSOpal)\nlibrary(dsBaseClient)\nlibrary(dsTidyverseClient)\n\n# Connect to the server\nbuilder <- DSI::newDSLoginBuilder()\nbuilder$append(\n  server = \"demo\",\n  url = \"https://opal-demo.obiba.org\",\n  user = \"dsuser\",\n  password = \"P@ssw0rd\",\n  table = \"CNSIM.CNSIM1\",\n  profile = \"margin-idiom\"\n)\nlogindata <- builder$build()\nconns <- datashield.login(logins = logindata, assign = TRUE, symbol = \"D\")\n```\n:::\n\n\n\n\n## Conditional Logic with ds.case_when()\n\n`ds.case_when()` allows multiple conditions, similar to SQL's CASE WHEN or dplyr's `case_when()`:\n\n### Winsorizing Variables\n\nCap extreme values at a threshold (common for BMI):\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# First, get the 95th percentile\nds.quantileMean(x = \"D$PM_BMI_CONTINUOUS\", type = \"combine\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n Quantiles of the pooled data\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      5%      10%      25%      50%      75%      90%      95%     Mean \n19.49500 21.06500 24.10500 27.33000 30.66750 33.76000 35.66750 27.39804 \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Winsorize BMI: cap values above 40\nds.case_when(\n  tidy_expr = list(\n    D$PM_BMI_CONTINUOUS <= 40 ~ D$PM_BMI_CONTINUOUS,  # Keep original if <= 40\n    D$PM_BMI_CONTINUOUS > 40 ~ 40                      # Cap at 40 if above\n  ),\n  newobj = \"bmi_capped\"\n)\n\n# Add the new variable to the data frame\nds.dataFrame(x = c(\"D\", \"bmi_capped\"), newobj = \"D\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Check the result\nds.summary(\"D$bmi_capped\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$demo\n$demo$class\n[1] \"numeric\"\n\n$demo$length\n[1] 2163\n\n$demo$`quantiles & mean`\n      5%      10%      25%      50%      75%      90%      95%     Mean \n19.49500 21.06500 24.10500 27.33000 30.66750 33.76000 35.66750 27.37089 \n```\n\n\n:::\n:::\n\n\n\n\n### Creating Categories\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create cholesterol categories based on LAB_TSC\n# Normal: < 5.2, Borderline: 5.2-6.2, High: > 6.2\nds.case_when(\n  tidy_expr = list(\n    D$LAB_TSC < 5.2 ~ 1,          # Normal\n    D$LAB_TSC >= 5.2 & D$LAB_TSC <= 6.2 ~ 2,  # Borderline\n    D$LAB_TSC > 6.2 ~ 3           # High\n  ),\n  newobj = \"chol_category\"\n)\nds.dataFrame(x = c(\"D\", \"chol_category\"), newobj = \"D\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nds.table(\"D$chol_category\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Data in all studies were valid \n\nStudy 1 :  No errors reported from this study\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$output.list\n$output.list$TABLE_rvar.by.study_row.props\n               study\nD$chol_category demo\n             1     1\n             2     1\n             3     1\n             NA    1\n\n$output.list$TABLE_rvar.by.study_col.props\n               study\nD$chol_category      demo\n             1  0.2306981\n             2  0.2935737\n             3  0.3111419\n             NA 0.1645862\n\n$output.list$TABLE_rvar.by.study_counts\n               study\nD$chol_category demo\n             1   499\n             2   635\n             3   673\n             NA  356\n\n$output.list$TABLES.COMBINED_all.sources_proportions\nD$chol_category\n    1     2     3    NA \n0.231 0.294 0.311 0.165 \n\n$output.list$TABLES.COMBINED_all.sources_counts\nD$chol_category\n  1   2   3  NA \n499 635 673 356 \n\n\n$validity.message\n[1] \"Data in all studies were valid\"\n```\n\n\n:::\n:::\n\n\n\n\n## Binary Conditions with ds.if_else()\n\n`ds.if_else()` provides simple if-else logic for binary conditions:\n\n### Creating Binary Indicators\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create overweight indicator (BMI >= 25)\nds.if_else(\n  condition = list(D$PM_BMI_CONTINUOUS >= 25),\n  true = 1,\n  false = 0,\n  newobj = \"is_overweight\"\n)\n\n# Add to data frame\nds.dataFrame(x = c(\"D\", \"is_overweight\"), newobj = \"D\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Check the result\nds.table(\"D$is_overweight\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Data in all studies were valid \n\nStudy 1 :  No errors reported from this study\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$output.list\n$output.list$TABLE_rvar.by.study_row.props\n               study\nD$is_overweight demo\n             0     1\n             1     1\n             NA    1\n\n$output.list$TABLE_rvar.by.study_col.props\n               study\nD$is_overweight       demo\n             0  0.29634767\n             1  0.65880721\n             NA 0.04484512\n\n$output.list$TABLE_rvar.by.study_counts\n               study\nD$is_overweight demo\n             0   641\n             1  1425\n             NA   97\n\n$output.list$TABLES.COMBINED_all.sources_proportions\nD$is_overweight\n     0      1     NA \n0.2960 0.6590 0.0448 \n\n$output.list$TABLES.COMBINED_all.sources_counts\nD$is_overweight\n   0    1   NA \n 641 1425   97 \n\n\n$validity.message\n[1] \"Data in all studies were valid\"\n```\n\n\n:::\n:::\n\n\n\n\n### Creating Combined Indicators\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create indicator for metabolic risk (diabetes OR high cholesterol)\nds.if_else(\n  condition = list(D$DIS_DIAB == 1 | D$LAB_TSC > 6.5),\n  true = 1,\n  false = 0,\n  newobj = \"metabolic_risk\"\n)\n\nds.dataFrame(x = c(\"D\", \"metabolic_risk\"), newobj = \"D\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nds.table(\"D$metabolic_risk\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Data in all studies were valid \n\nStudy 1 :  No errors reported from this study\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$output.list\n$output.list$TABLE_rvar.by.study_row.props\n                study\nD$metabolic_risk demo\n              0     1\n              1     1\n              NA    1\n\n$output.list$TABLE_rvar.by.study_col.props\n                study\nD$metabolic_risk      demo\n              0  0.5982432\n              1  0.2390199\n              NA 0.1627369\n\n$output.list$TABLE_rvar.by.study_counts\n                study\nD$metabolic_risk demo\n              0  1294\n              1   517\n              NA  352\n\n$output.list$TABLES.COMBINED_all.sources_proportions\nD$metabolic_risk\n    0     1    NA \n0.598 0.239 0.163 \n\n$output.list$TABLES.COMBINED_all.sources_counts\nD$metabolic_risk\n   0    1   NA \n1294  517  352 \n\n\n$validity.message\n[1] \"Data in all studies were valid\"\n```\n\n\n:::\n:::\n\n\n\n\n## Recoding Values with ds.recodeValues()\n\nRecode specific values in a variable:\n\n### Single Value Replacement\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Recode GENDER: 0,1 -> 1,2\nds.recodeValues(\n  var.name = \"D$GENDER\",\n  values2replace.vector = c(0, 1),\n  new.values.vector = c(1, 2),\n  newobj = \"gender_recoded\"\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nds.table(\"gender_recoded\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Data in all studies were valid \n\nStudy 1 :  No errors reported from this study\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$output.list\n$output.list$TABLE_rvar.by.study_row.props\n              study\ngender_recoded demo\n            1     1\n            2     1\n            NA  NaN\n\n$output.list$TABLE_rvar.by.study_col.props\n              study\ngender_recoded      demo\n            1  0.5048544\n            2  0.4951456\n            NA 0.0000000\n\n$output.list$TABLE_rvar.by.study_counts\n              study\ngender_recoded demo\n            1  1092\n            2  1071\n            NA    0\n\n$output.list$TABLES.COMBINED_all.sources_proportions\ngender_recoded\n    1     2    NA \n0.505 0.495 0.000 \n\n$output.list$TABLES.COMBINED_all.sources_counts\ngender_recoded\n   1    2   NA \n1092 1071    0 \n\n\n$validity.message\n[1] \"Data in all studies were valid\"\n```\n\n\n:::\n:::\n\n\n\n\n### Recoding to Binary\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Recode PM_BMI_CATEGORICAL to binary (normal vs overweight/obese)\nds.recodeValues(\n  var.name = \"D$PM_BMI_CATEGORICAL\",\n  values2replace.vector = c(1, 2, 3),\n  new.values.vector = c(0, 1, 1),\n  newobj = \"bmi_binary\"\n)\n\nds.table(\"bmi_binary\")\n```\n:::\n\n\n\n\n## Creating Derived Variables with ds.make()\n\nUse `ds.make()` for arithmetic operations and creating variable copies:\n\n### Arithmetic Operations\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create HDL to total cholesterol ratio\nds.make(\n  toAssign = \"D$LAB_HDL / D$LAB_TSC\",\n  newobj = \"hdl_ratio\"\n)\nds.dataFrame(x = c(\"D\", \"hdl_ratio\"), newobj = \"D\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nds.summary(\"D$hdl_ratio\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$demo\n$demo$class\n[1] \"numeric\"\n\n$demo$length\n[1] 2163\n\n$demo$`quantiles & mean`\n       5%       10%       25%       50%       75%       90%       95%      Mean \n0.1313137 0.1655379 0.2145864 0.2730897 0.3371916 0.4000319 0.4549046 0.2799964 \n```\n\n\n:::\n:::\n\n\n\n\n### Creating Variable Copies\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create a copy of BMI as the primary exposure variable\nds.make(\n  toAssign = \"D$PM_BMI_CONTINUOUS\",\n  newobj = \"Primary_exposure\"\n)\n\nds.dataFrame(x = c(\"D\", \"Primary_exposure\"), newobj = \"D\")\n```\n:::\n\n\n\n\n## Converting Variable Types\n\n### Numeric to Factor\n\nConvert categorical variables to factors for modeling:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Convert GENDER to factor\nds.asFactor(input.var.name = \"D$GENDER\", newobj.name = \"gender_f\")\n\n# Convert DIS_DIAB to factor\nds.asFactor(input.var.name = \"D$DIS_DIAB\", newobj.name = \"diabetes_f\")\n\n# Add factors to data frame\nds.dataFrame(x = c(\"D\", \"gender_f\", \"diabetes_f\"), newobj = \"D\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Check levels\nds.levels(\"gender_f\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$demo\n$demo$Levels\n[1] \"0\" \"1\"\n\n$demo$ValidityMessage\n[1] \"VALID ANALYSIS\"\n```\n\n\n:::\n:::\n\n\n\n\n### Factor to Numeric\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Convert back to numeric\nds.asNumeric(x.name = \"D$DIS_DIAB\", newobj = \"diabetes_numeric\")\n```\n:::\n\n\n\n\n## Multiple Imputation with ds.mice()\n\nFor handling missing data, use `ds.mice()`:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Perform multiple imputation using random forest method\nds.mice(\n  data = \"D\",\n  m = 5,                       # Number of imputations\n  method = \"rf\",               # Random forest method\n  newobj_df = \"imputed_data\",  # Output data frame prefix\n  seed = \"fixed\",              # For reproducibility\n  newobj_mids = \"imputed_mids\" # MICE object for diagnostics\n)\n\n# The function creates multiple imputed datasets:\n# imputed_data.1, imputed_data.2, ..., imputed_data.5\n```\n:::\n\n\n\n\n\n## Best Practices\n\n::: {.callout-tip}\n## Conditional Operations Tips\n1. **Use `ds.case_when()`** for multiple conditions or value transformations\n2. **Use `ds.if_else()`** for simple binary conditions\n3. **Always add new variables to data frame** with `ds.dataFrame()`\n4. **Convert to factors** before modeling categorical variables\n5. **Check your results** with `ds.table()` or `ds.summary()`\n:::\n\n\n\n\n\n\n\n\n\n## Next Steps\n\nContinue to [Derived Variables](5-derived-variables.qmd) to learn about creating more complex derived variables and grouped summaries.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}